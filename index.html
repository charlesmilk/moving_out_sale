<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Moving Sale</title>
  <style>
    :root{
      --muted:#9aa4b2; --text:#e7edf5; --accent:#6ea8fe;
      --border:rgba(255,255,255,.08);
    }
    *{box-sizing:border-box}
    html{background:#070810;overflow-x:hidden}
    body{margin:0;background:linear-gradient(180deg,#0b0d12,#070810);color:var(--text);font:15px/1.4 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;overflow-x:hidden}

    header{padding:28px 18px 10px;max-width:1100px;margin:0 auto}
    h1{margin:0 0 8px;font-size:26px}
    .sub{margin:0;color:var(--muted)}

    .toolbar{max-width:1100px;margin:0 auto;padding:14px 18px;display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .pill{display:flex;gap:10px;align-items:center;background:rgba(255,255,255,.04);border:1px solid var(--border);padding:10px 12px;border-radius:14px}
    input,textarea,button,select{font:inherit}
    input[type="search"],select{background:transparent;border:0;outline:none;color:var(--text)}
    select{appearance:none}
    .spacer{flex:1}
    .adminBadge{display:none;padding:6px 10px;border-radius:999px;border:1px dashed var(--border);color:var(--muted)}
    .status{display:none;color:var(--muted);font-size:12px}

    main{max-width:1100px;margin:0 auto;padding:0 18px 18px}
    .grid{display:grid;grid-template-columns:repeat(3, minmax(0,1fr));gap:14px;width:100%}
    @media (max-width:980px){.grid{grid-template-columns:repeat(2, minmax(0,1fr))}}
    @media (max-width:640px){.grid{grid-template-columns:1fr}}

    .card{position:relative;background:rgba(255,255,255,.03);border:1px solid var(--border);border-radius:18px;overflow:hidden;box-shadow:0 10px 30px rgba(0,0,0,.25)}
    .thumb{position:relative;aspect-ratio: 4/3; background:#0a0c12;display:block;overflow:hidden}
    .thumb.clickable{cursor:pointer}
    .thumb img{width:100%;height:100%;object-fit:cover;display:block;transform:scale(1.01)}
    .content{padding:12px 12px 14px}
    .titleRow{display:flex;gap:10px;align-items:flex-start}
    .title{margin:0;font-size:16px;line-height:1.25;min-width:0}

    .priceWrap{margin-left:auto;display:flex;gap:10px;align-items:baseline;flex-wrap:wrap;justify-content:flex-end}
    .oldPrice{color:rgba(231,237,245,.62);text-decoration:line-through;text-decoration-thickness:2px;font-size:14px;font-weight:700}
    .newPrice{font-weight:900;font-size:16px;color:#d7f5df}
    .desc{margin:8px 0 0;color:var(--muted);font-size:13px}

    /* SOLD visuals â€” scoped ONLY to cards */
    .soldOverlay{display:none;position:absolute;inset:0;background:rgba(11,13,18,.72);backdrop-filter: blur(2px);z-index:2;pointer-events:none}
    .soldStamp{display:none;position:absolute;top:12px;left:12px;background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.18);padding:8px 10px;border-radius:12px;font-weight:800;letter-spacing:.08em;z-index:3;pointer-events:none}
    .card.sold .soldOverlay{display:block}
    .card.sold .soldStamp{display:block}
    .card.sold .thumb img{filter:grayscale(1) contrast(.9) brightness(.85)}
    .card.sold .newPrice{color:rgba(231,237,245,.55)}
    .card.sold .title{color:rgba(231,237,245,.75)}
    .card.sold .desc{color:rgba(154,164,178,.75)}

    /* Admin buttons */
    .adminBtnRow{position:absolute;bottom:10px;right:10px;display:flex;gap:8px;z-index:4}
    .adminBtn{background:rgba(0,0,0,.72);border:1px solid rgba(255,255,255,.28);color:var(--text);padding:7px 10px;border-radius:10px;font-size:12px;cursor:pointer}
    .adminBtn:hover{background:rgba(0,0,0,.85);border-color:rgba(255,255,255,.45)}
    .adminBtn:active{transform:translateY(1px)}
    .adminBtn:focus{outline:2px solid rgba(110,168,254,.55);outline-offset:2px}

    .btn{background:rgba(255,255,255,.06);border:1px solid var(--border);color:var(--text);padding:8px 10px;border-radius:12px;cursor:pointer}
    .btn:hover{border-color:rgba(255,255,255,.18)}

    /* Modal */
    .modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.62);align-items:center;justify-content:center;padding:18px;z-index:50;overflow:auto;-webkit-overflow-scrolling:touch;overflow-x:hidden}
    .modal.open{display:flex}
    .dialog{max-width:980px;width:100%;background:rgba(17,21,37,.96);border:1px solid var(--border);border-radius:20px;overflow:hidden;box-shadow:0 18px 70px rgba(0,0,0,.55);max-height:calc(100dvh - 36px);display:flex;flex-direction:column;overflow-x:hidden}
    .dialogTop{display:flex;gap:10px;align-items:center;padding:12px 12px;border-bottom:1px solid var(--border);position:sticky;top:0;background:rgba(17,21,37,.98);z-index:2}
    .dialogTop b{font-size:14px}
    .close{margin-left:auto}

    .dialogBody{display:grid;grid-template-columns: 2fr 1fr;gap:0;min-height:0;flex:1;overflow:hidden}
    .dialogBody > *{min-width:0}
    @media (max-width:860px){.dialogBody{grid-template-columns:1fr}}
    @media (max-width:640px){
      .modal{padding:10px;align-items:flex-start}
      .dialog{max-height:calc(100dvh - 20px)}
      .hero{aspect-ratio: 4/3}
      .thumbs button{width:64px;height:48px}
    }

    .viewer{padding:12px;min-height:0;min-width:0;overflow:auto;-webkit-overflow-scrolling:touch}
    .hero{position:relative;aspect-ratio: 16/10;background:#070810;border-radius:14px;overflow:hidden;border:1px solid var(--border)}
    .hero img{width:100%;height:100%;object-fit:contain;background:#05060a}
    .navBtn{position:absolute;top:50%;transform:translateY(-50%);background:rgba(0,0,0,.35);border:1px solid rgba(255,255,255,.16);padding:8px 10px;border-radius:12px;cursor:pointer}
    .navBtn:hover{background:rgba(0,0,0,.5)}
    .prev{left:10px} .next{right:10px}

    .thumbs{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
    .thumbs button{padding:0;border:1px solid var(--border);border-radius:10px;overflow:hidden;background:transparent;cursor:pointer;width:72px;height:54px}
    .thumbs img{width:100%;height:100%;object-fit:cover;display:block}
    .thumbs .active{border-color:rgba(110,168,254,.7)}

    aside{padding:12px;border-left:1px solid var(--border);min-height:0;min-width:0;overflow:auto;-webkit-overflow-scrolling:touch}
    @media (max-width:860px){aside{border-left:0;border-top:1px solid var(--border)}}
    .asideTitle{margin:0 0 6px;font-size:18px}
    .asidePrice{margin:0 0 10px}
    .asideDesc{color:var(--muted);margin:0 0 14px}

    .priceBlock{display:flex;gap:12px;align-items:baseline;flex-wrap:wrap}
    .priceBlock .oldPrice{font-size:18px}
    .priceBlock .newPrice{font-size:22px}

    .sectionLabel{margin:12px 0 6px;color:rgba(231,237,245,.85);font-size:12px;letter-spacing:.06em;text-transform:uppercase}
    .sectionBox{border:1px solid var(--border);border-radius:14px;padding:10px;background:rgba(255,255,255,.03)}
    .kv{margin:0;color:var(--muted);font-size:13px}
    .kv + .kv{margin-top:8px}
    .kv b{color:rgba(231,237,245,.85);font-weight:600}
    .kv a{color:var(--accent);text-decoration:none;word-break:break-word;overflow-wrap:anywhere}
    .kv a:hover{text-decoration:underline}

    form{display:grid;gap:10px}
    textarea{min-height:90px;resize:vertical}
    .field{display:grid;gap:6px}
    label{font-size:12px;color:var(--muted)}
    input[type="text"],input[type="email"],input[type="number"],textarea{
      background:rgba(255,255,255,.04);
      border:1px solid var(--border);
      border-radius:12px;
      padding:10px 10px;
      color:var(--text);
      outline:none;
      width:100%;
    }
    input:focus,textarea:focus{border-color:rgba(110,168,254,.55)}
    .formNote{color:var(--muted);font-size:12px;margin:0}
    .successNote{display:none;color:rgba(215,245,223,.9);font-size:12px;margin:8px 0 0}
    .errorNote{display:none;color:rgba(255,194,194,.95);font-size:12px;margin:8px 0 0}

    /* Admin edit price modal */
    .miniModal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.62);align-items:center;justify-content:center;padding:18px;z-index:60;overflow:auto}
    .miniModal.open{display:flex}
    .miniDialog{max-width:520px;width:100%;background:rgba(17,21,37,.98);border:1px solid var(--border);border-radius:18px;overflow:hidden;box-shadow:0 18px 70px rgba(0,0,0,.55)}
    .miniTop{display:flex;gap:10px;align-items:center;padding:12px;border-bottom:1px solid var(--border)}
    .miniBody{padding:12px}
    .miniActions{display:flex;gap:10px;justify-content:flex-end;margin-top:10px}

    /* Map section */
    .mapWrap{max-width:1100px;margin:0 auto;padding:10px 18px 40px}
    .mapCard{border:1px solid var(--border);border-radius:18px;overflow:hidden;background:rgba(255,255,255,.03);box-shadow:0 10px 30px rgba(0,0,0,.25)}
    .mapHeader{padding:12px 12px;border-bottom:1px solid var(--border)}
    .mapHeader b{display:block;margin-bottom:4px}
    .mapHeader span{color:var(--muted);font-size:13px}
    .mapCard iframe{width:100%;height:340px;border:0;display:block}

    .foot{max-width:1100px;margin:0 auto;padding:18px;color:var(--muted);font-size:12px}
    code{color:#cfe2ff}
  </style>
</head>
<body>
  <header>
    <h1>Moving Sale</h1>
    <p class="sub">Browse items, open photos, and send a message to buy.</p>
  </header>

  <div class="toolbar">
    <div class="pill">
      ðŸ”Ž <input id="q" type="search" placeholder="Search itemsâ€¦" autocomplete="off" />
    </div>
    <div class="pill">
      Filter:
      <select id="filter">
        <option value="all">All</option>
        <option value="available">Available only</option>
        <option value="sold">Sold only</option>
      </select>
    </div>

    <div class="pill status" id="status"></div>

    <div class="spacer"></div>
    <div id="adminBadge" class="adminBadge">Admin mode</div>
  </div>

  <main>
    <div id="grid" class="grid"></div>
  </main>

  <div class="mapWrap">
    <div class="mapCard">
      <div class="mapHeader">
        <b>Collection available at</b>
        <span>The Gessner, 3 Watermead Way, London, N17 9RF</span>
      </div>
      <iframe loading="lazy" referrerpolicy="no-referrer-when-downgrade"
        src="https://www.google.com/maps?q=The%20Gessner%2C%203%20Watermead%20Way%2C%20London%2C%20N17%209RF&output=embed"></iframe>
    </div>
  </div>

  <div class="foot">
    <p>Admin: add <code>?admin=1</code>. You can mark items sold/available and edit prices.</p>
  </div>

  <!-- Item Modal -->
  <div id="modal" class="modal" aria-hidden="true">
    <div class="dialog" role="dialog" aria-modal="true">
      <div class="dialogTop">
        <b id="modalTitle">Item</b>
        <button id="closeBtn" class="btn close" type="button">Close</button>
      </div>
      <div class="dialogBody">
        <div class="viewer">
          <div class="hero">
            <img id="heroImg" alt="" />
            <button id="prevBtn" class="navBtn prev" type="button">â—€</button>
            <button id="nextBtn" class="navBtn next" type="button">â–¶</button>
          </div>
          <div id="thumbs" class="thumbs"></div>
        </div>
        <aside>
          <h2 id="asideTitle" class="asideTitle"></h2>
          <div id="asidePrice" class="asidePrice"></div>
          <p id="asideDesc" class="asideDesc"></p>

          <div id="itemSection" style="display:none">
            <div class="sectionLabel">Item details</div>
            <div class="sectionBox">
              <div id="asideDims" class="kv" style="display:none"></div>
              <div id="asideLink" class="kv" style="display:none"></div>
            </div>
          </div>

          <div class="sectionLabel" style="margin-top:14px">Contact</div>

          <form id="contact" name="contact" method="POST" data-netlify="true" data-netlify-honeypot="bot-field">
            <input type="hidden" name="form-name" value="contact" />
            <p style="display:none">
              <label>Donâ€™t fill this out if youâ€™re human: <input name="bot-field" /></label>
            </p>

            <input type="hidden" name="item_id" id="f_item_id" />
            <input type="hidden" name="item_name" id="f_item_name" />
            <input type="hidden" name="item_price_now" id="f_item_price_now" />

            <div class="field">
              <label for="f_name">Your name</label>
              <input id="f_name" name="name" type="text" required />
            </div>
            <div class="field">
              <label for="f_email">Your email</label>
              <input id="f_email" name="email" type="email" required />
            </div>
            <div class="field">
              <label for="f_msg">Message</label>
              <textarea id="f_msg" name="message" required></textarea>
            </div>
            <button class="btn" type="submit" id="sendBtn">Send message</button>
            <p class="formNote">Tip: include your preferred pickup time.</p>
            <p class="successNote" id="formSuccess">Message sent. Iâ€™ll reply by email.</p>
            <p class="errorNote" id="formError">Couldnâ€™t send. Try again, or refresh and retry.</p>
          </form>
        </aside>
      </div>
    </div>
  </div>

  <!-- Admin: Edit Prices Modal -->
  <div id="priceModal" class="miniModal" aria-hidden="true">
    <div class="miniDialog" role="dialog" aria-modal="true">
      <div class="miniTop">
        <b id="priceModalTitle">Edit prices</b>
        <button id="priceCloseBtn" class="btn close" type="button">Close</button>
      </div>
      <div class="miniBody">
        <form id="priceForm">
          <input type="hidden" id="p_item_id" />
          <div class="field">
            <label for="p_original">Original price (GBP)</label>
            <input id="p_original" type="number" min="0" step="1" placeholder="e.g. 100" />
          </div>
          <div class="field">
            <label for="p_current">Current price (GBP)</label>
            <input id="p_current" type="number" min="0" step="1" placeholder="e.g. 45" required />
          </div>
          <div class="miniActions">
            <button class="btn" type="button" id="priceCancel">Cancel</button>
            <button class="btn" type="submit">Save</button>
          </div>
          <p style="color:var(--muted);font-size:12px;margin:10px 0 0">
            Requires <code>/.netlify/functions/update-prices</code>.
          </p>
        </form>
      </div>
    </div>
  </div>

  <script>
    const params = new URLSearchParams(location.search);
    const isAdmin = params.get("admin") === "1";

    const grid = document.getElementById("grid");
    const q = document.getElementById("q");
    const filter = document.getElementById("filter");
    const adminBadge = document.getElementById("adminBadge");
    const statusEl = document.getElementById("status");
    if (isAdmin) adminBadge.style.display = "inline-block";

    function setStatus(msg) {
      if (!msg) { statusEl.style.display="none"; statusEl.textContent=""; return; }
      statusEl.style.display="flex"; statusEl.textContent=msg;
    }

    function moneyGBP(n){
      const v = Number(n);
      if (!Number.isFinite(v)) return "";
      try { return new Intl.NumberFormat("en-GB", { style:"currency", currency:"GBP", maximumFractionDigits:0 }).format(v); }
      catch { return `Â£${Math.round(v)}`; }
    }

    function escapeHtml(str){
      return String(str ?? "")
        .replaceAll("&", "&amp;").replaceAll("<", "&lt;").replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;").replaceAll("'", "&#039;");
    }

    function toBool(v){
      if (v === true || v === 1 || v === "1" || v === "t" || v === "true") return true;
      if (v === false || v === 0 || v === "0" || v === "f" || v === "false" || v === null || v === undefined) return false;
      return Boolean(v);
    }

    function match(item, query){
      if (!query) return true;
      const hay = [item.title, item.description, item.dimensions, item.item_link].filter(Boolean).join(" ").toLowerCase();
      return hay.includes(query.toLowerCase());
    }
    function passesFilter(item){
      const sold = !!item.sold;
      if (filter.value === "available") return !sold;
      if (filter.value === "sold") return sold;
      return true;
    }

    const DEMO_ITEMS = [{
      id:"demo-1",
      title:"Demo item (items function unavailable)",
      description:"If you see this, /.netlify/functions/items failed.",
      price_gbp:45, original_price:100,
      dimensions:null, item_link:null,
      images:[], sold:false, sort_order:10
    }];

    let ITEMS = [];

    async function refreshItems() {
      setStatus("Loadingâ€¦");
      try {
        const res = await fetch("/.netlify/functions/items", { cache: "no-store" });
        if (!res.ok) throw new Error(`items function HTTP ${res.status}`);
        const rows = await res.json();

        ITEMS = (Array.isArray(rows) ? rows : []).map(r => ({
          id: r.id,
          title: r.title,
          description: r.description ?? "",
          price_gbp: Number(r.price_gbp ?? 0),
          original_price: (r.original_price === null || r.original_price === undefined || r.original_price === "") ? null : Number(r.original_price),
          dimensions: (r.dimensions ?? null) || null,
          item_link: (r.item_link ?? null) || null,
          images: Array.isArray(r.images) ? r.images : [],
          sold: toBool(r.sold),
          sort_order: Number(r.sort_order ?? 0)
        })).sort((a,b) => (a.sort_order - b.sort_order));

        setStatus("");
        render();
      } catch (err) {
        ITEMS = DEMO_ITEMS;
        setStatus("Data source error: using demo fallback.");
        render();
      }
    }

    async function postAdminJson(url, payload) {
      const adminSecret = prompt("Admin secret:");
      if (!adminSecret) return { ok:false, cancelled:true };

      const res = await fetch(url, {
        method: "POST",
        headers: { "Content-Type":"application/json", "x-admin-secret": adminSecret },
        body: JSON.stringify(payload)
      });
      if (!res.ok) return { ok:false, status: res.status };
      return { ok:true, data: await res.json().catch(() => null) };
    }

    async function setSold(item, sold) {
      setStatus("Updatingâ€¦");
      const r = await postAdminJson("/.netlify/functions/toggle-sold", { id: item.id, sold: !!sold });
      if (!r.ok) { setStatus("Update failed."); return; }
      await refreshItems();
    }

    // iOS-safe scroll lock
    let __scrollY = 0;
    function lockPageScroll() {
      __scrollY = window.scrollY || 0;
      document.body.style.position = "fixed";
      document.body.style.top = `-${__scrollY}px`;
      document.body.style.left = "0";
      document.body.style.right = "0";
      document.body.style.width = "100%";
    }
    function unlockPageScroll() {
      const y = __scrollY || 0;
      document.body.style.position = "";
      document.body.style.top = "";
      document.body.style.left = "";
      document.body.style.right = "";
      document.body.style.width = "";
      window.scrollTo(0, y);
    }

    // Admin price edit modal
    const priceModal = document.getElementById("priceModal");
    const priceCloseBtn = document.getElementById("priceCloseBtn");
    const priceCancel = document.getElementById("priceCancel");
    const priceForm = document.getElementById("priceForm");
    const priceModalTitle = document.getElementById("priceModalTitle");
    const p_item_id = document.getElementById("p_item_id");
    const p_original = document.getElementById("p_original");
    const p_current = document.getElementById("p_current");

    function openPriceModal(item) {
      priceModalTitle.textContent = `Edit prices: ${item.title}`;
      p_item_id.value = item.id;
      p_original.value = (item.original_price ?? "") === null ? "" : (item.original_price ?? "");
      p_current.value = item.price_gbp ?? "";
      priceModal.classList.add("open");
      priceModal.setAttribute("aria-hidden", "false");
      lockPageScroll();
      p_current.focus();
    }
    function closePriceModal() {
      priceModal.classList.remove("open");
      priceModal.setAttribute("aria-hidden", "true");
      unlockPageScroll();
    }
    priceCloseBtn.addEventListener("click", closePriceModal);
    priceCancel.addEventListener("click", closePriceModal);
    priceModal.addEventListener("click", (e) => { if (e.target === priceModal) closePriceModal(); });

    priceForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      const id = p_item_id.value;
      const originalVal = p_original.value === "" ? null : Number(p_original.value);
      const currentVal = Number(p_current.value);
      if (!id || !Number.isFinite(currentVal)) return;

      setStatus("Saving pricesâ€¦");
      const r = await postAdminJson("/.netlify/functions/update-prices", {
        id,
        original_price: (originalVal === null ? null : Math.round(originalVal)),
        price_gbp: Math.round(currentVal)
      });
      if (!r.ok) { setStatus("Price update failed."); return; }
      closePriceModal();
      await refreshItems();
    });

    function priceHtml(item, big=false) {
      const now = moneyGBP(item.price_gbp);
      const orig = (item.original_price !== null && Number.isFinite(item.original_price) && item.original_price > 0) ? moneyGBP(item.original_price) : "";
      if (!orig || orig === now) return `<span class="newPrice" style="${big ? 'font-size:22px;' : ''}">${now}</span>`;
      return `<span class="oldPrice">${orig}</span><span class="newPrice" style="${big ? 'font-size:22px;' : ''}">${now}</span>`;
    }

    function render(){
      const query = q.value.trim();
      const list = ITEMS.filter(it => match(it, query)).filter(it => passesFilter(it));

      grid.innerHTML = "";
      if (list.length === 0){
        grid.innerHTML = `<div style="grid-column:1/-1;color:var(--muted);padding:14px">No items match.</div>`;
        return;
      }

      for (const item of list){
        const card = document.createElement("div");
        card.className = "card" + (item.sold ? " sold" : "");

        const img0 = item.images?.[0] || "";
        const isInteractive = isAdmin || !item.sold;

        const adminBtns = isAdmin ? `
          <div class="adminBtnRow">
            <button class="adminBtn adminToggle" type="button">${item.sold ? "Mark Available" : "Mark Sold"}</button>
            <button class="adminBtn adminEdit" type="button">Edit Prices</button>
          </div>
        ` : "";

        card.innerHTML = `
          <div class="thumb ${isInteractive ? "clickable" : ""}" role="${isInteractive ? "button" : "img"}" tabindex="${isInteractive ? "0" : "-1"}" aria-label="${isInteractive ? "Open photos" : "Sold item"}" aria-disabled="${isInteractive ? "false" : "true"}">
            ${img0 ? `<img src="${img0}" alt="${escapeHtml(item.title)}" loading="lazy" />` : `<div style="padding:18px;color:var(--muted)">No image</div>`}
            ${adminBtns}
          </div>
          <div class="content">
            <div class="titleRow">
              <h3 class="title">${escapeHtml(item.title)}</h3>
              <div class="priceWrap">${priceHtml(item,false)}</div>
            </div>
            <p class="desc">${escapeHtml(item.description)}</p>
          </div>
          <div class="soldOverlay" aria-hidden="true"></div>
          <div class="soldStamp" aria-hidden="true">SOLD</div>
        `;

        const thumb = card.querySelector(".thumb");
        if (isInteractive){
          thumb.addEventListener("click", () => openModal(item));
          thumb.addEventListener("keydown", (e) => { if (e.key === "Enter" || e.key === " ") openModal(item); });
        }

        if (isAdmin){
          card.querySelector(".adminToggle")?.addEventListener("click", async (e) => {
            e.preventDefault(); e.stopPropagation();
            await setSold(item, !item.sold);
          });
          card.querySelector(".adminEdit")?.addEventListener("click", (e) => {
            e.preventDefault(); e.stopPropagation();
            openPriceModal(item);
          });
        }

        grid.appendChild(card);
      }
    }

    // Item modal carousel
    const modal = document.getElementById("modal");
    const closeBtn = document.getElementById("closeBtn");
    const modalTitle = document.getElementById("modalTitle");
    const heroImg = document.getElementById("heroImg");
    const thumbs = document.getElementById("thumbs");
    const prevBtn = document.getElementById("prevBtn");
    const nextBtn = document.getElementById("nextBtn");
    const asideTitle = document.getElementById("asideTitle");
    const asidePrice = document.getElementById("asidePrice");
    const asideDesc = document.getElementById("asideDesc");
    const itemSection = document.getElementById("itemSection");
    const asideDims = document.getElementById("asideDims");
    const asideLink = document.getElementById("asideLink");

    const contactForm = document.getElementById("contact");
    const sendBtn = document.getElementById("sendBtn");
    const formSuccess = document.getElementById("formSuccess");
    const formError = document.getElementById("formError");

    const f_item_id = document.getElementById("f_item_id");
    const f_item_name = document.getElementById("f_item_name");
    const f_item_price_now = document.getElementById("f_item_price_now");
    const f_msg = document.getElementById("f_msg");

    let activeItem = null;
    let activeIndex = 0;

    function openModal(item){
      activeItem = item;
      activeIndex = 0;

      modalTitle.textContent = item.title;
      asideTitle.textContent = item.title;
      asidePrice.innerHTML = `<div class="priceBlock">${priceHtml(item,true)}</div>`;
      asideDesc.textContent = item.description;

      const showDims = !!item.dimensions;
      const showLink = !!item.item_link;

      if (showDims){
        asideDims.style.display = "block";
        asideDims.innerHTML = `<b>Dimensions:</b> ${escapeHtml(item.dimensions)}`;
      } else {
        asideDims.style.display = "none";
        asideDims.innerHTML = "";
      }

      if (showLink){
        asideLink.style.display = "block";
        const safeUrl = String(item.item_link);
        asideLink.innerHTML = `<b>Item link:</b> <a href="${safeUrl}" target="_blank" rel="noopener noreferrer">Open original listing</a>`;
      } else {
        asideLink.style.display = "none";
        asideLink.innerHTML = "";
      }

      itemSection.style.display = (showDims || showLink) ? "block" : "none";

      formSuccess.style.display = "none";
      formError.style.display = "none";
      sendBtn.disabled = false;

      f_item_id.value = item.id;
      f_item_name.value = item.title;
      f_item_price_now.value = moneyGBP(item.price_gbp);
      f_msg.value = `Hi â€” I'm interested in: ${item.title} (${moneyGBP(item.price_gbp)}). Is it still available?`;

      buildThumbs(item);
      setHero(item, 0);

      modal.classList.add("open");
      modal.setAttribute("aria-hidden", "false");
      lockPageScroll();
    }

    function closeModal(){
      modal.classList.remove("open");
      modal.setAttribute("aria-hidden", "true");
      unlockPageScroll();
      activeItem = null;
    }

    function setHero(item, idx){
      const imgs = item.images || [];
      if (!imgs.length){
        heroImg.removeAttribute("src");
        heroImg.alt = "";
        prevBtn.style.display = "none";
        nextBtn.style.display = "none";
        return;
      }
      activeIndex = (idx + imgs.length) % imgs.length;
      heroImg.src = imgs[activeIndex];
      heroImg.alt = item.title;

      prevBtn.style.display = imgs.length > 1 ? "block" : "none";
      nextBtn.style.display = imgs.length > 1 ? "block" : "none";

      [...thumbs.querySelectorAll("button")].forEach((b, i) => b.classList.toggle("active", i === activeIndex));
    }

    function buildThumbs(item){
      thumbs.innerHTML = "";
      const imgs = item.images || [];
      for (let i=0;i<imgs.length;i++){
        const b = document.createElement("button");
        b.type = "button";
        b.innerHTML = `<img src="${imgs[i]}" alt="" loading="lazy" />`;
        b.addEventListener("click", () => setHero(item, i));
        thumbs.appendChild(b);
      }
    }

    prevBtn.addEventListener("click", () => { if (activeItem) setHero(activeItem, activeIndex - 1); });
    nextBtn.addEventListener("click", () => { if (activeItem) setHero(activeItem, activeIndex + 1); });

    closeBtn.addEventListener("click", closeModal);
    modal.addEventListener("click", (e) => { if (e.target === modal) closeModal(); });

    window.addEventListener("keydown", (e) => {
      if (!modal.classList.contains("open") && !priceModal.classList.contains("open")) return;
      if (e.key === "Escape") { if (priceModal.classList.contains("open")) closePriceModal(); else closeModal(); }
      if (!modal.classList.contains("open")) return;
      if (e.key === "ArrowLeft" && activeItem) setHero(activeItem, activeIndex - 1);
      if (e.key === "ArrowRight" && activeItem) setHero(activeItem, activeIndex + 1);
    });

    // Netlify Forms AJAX submit
    function encodeFormData(form) {
      const data = new FormData(form);
      const p = new URLSearchParams();
      for (const [k, v] of data.entries()) p.append(k, v);
      return p.toString();
    }

    contactForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      formSuccess.style.display = "none";
      formError.style.display = "none";
      sendBtn.disabled = true;

      try {
        const body = encodeFormData(contactForm);
        const res = await fetch(location.pathname, {
          method: "POST",
          headers: { "Content-Type": "application/x-www-form-urlencoded" },
          body
        });
        if (!res.ok) throw new Error("Bad response");
        formSuccess.style.display = "block";
        sendBtn.disabled = false;
      } catch (err) {
        formError.style.display = "block";
        sendBtn.disabled = false;
      }
    });

    q.addEventListener("input", render);
    filter.addEventListener("change", render);

    refreshItems();
  </script>
</body>
</html>
